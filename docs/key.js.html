<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: key.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: key.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const { FFError } = require('./error')
const {
  SPECIAL_CHARS: { QUERY_DELIMITER },
  validatePaginationOpts
} = require('./utils')

/**
 * Creates a new QueryKey instance.
 * @constructor
 * @param {String} dbName - The database to query
 * @param {String} collectionName - The collection to query
 * @param {Object} query - The cursor query object.
 * @param {Object} queryOptions - The query options.
 * @param {String} [ns='ff'] - The namescape to use for keys.
 */
class QueryKey {
  constructor (dbName, collectionName, query, queryOptions, ns = 'ff') {
    this.ns = ns
    this.dbName = dbName
    this.collectionName = collectionName
    this.query = query
    this.queryOptions = queryOptions

    /* INTERNAL -- cache stringifies */
    this._queryString = null
    this._toString = null
    this._baseKey = null
    this._oneKey = null
  }

  /**
   * Generates a QueryKey string without query options
   * @returns {String} The base key string.
   */
  baseKey () {
    if (!this._baseKey) {
      this._baseKey = this.toString(true)
    }

    return this._baseKey
  }

  /**
   * Generates a QueryKey string to be used with individual retrievals.
   * @returns {String} The one key string.
   */
  oneKey () {
    if (!this._oneKey) {
      this._oneKey = `${this.ns}:${this.dbName}::${this.collectionName}:findOne`
    }

    return this._oneKey
  }

  /**
   * Generate a QueryKey string which includes only the query itself.
   * @returns {String} The Query string.
   */
  queryString () {
    if (!this._queryString) {
      this._queryString = JSON.stringify(
        this.query,
        (k, value) => {
          if (value.constructor.name === 'RegExp') {
            /* Redis doesnt like backslashes in keys */
            return encodeURI(value.toString())
          }
          return value
        },
        0
      )
    }

    return this._queryString
  }

  /**
   * Generates a QueryKey string.
   * @param {boolean} [baseKeyOnly=false] - Generate only the base key variant.
   * @returns {String} The QueryKey string.
   */
  toString (baseKeyOnly = false) {
    if (this._toString &amp;&amp; !baseKeyOnly) return this._toString

    try {
      const stringQuery = JSON.stringify(
        this.query,
        (k, value) => {
          if (value.constructor.name === 'RegExp') {
            /* Redis doesnt like backslashes in keys */
            return encodeURI(value.toString())
          }
          return value
        },
        0
      )

      /* Full key */
      if (
        !baseKeyOnly &amp;&amp;
        this.queryOptions &amp;&amp;
        Object.keys(this.queryOptions).length !== 0
      ) {
        const options = {}

        const pageOptions = validatePaginationOpts(this.queryOptions)

        if (pageOptions) {
          options.start = pageOptions.start
          options.end = pageOptions.end
        }

        const stringFilteredOpts = JSON.stringify(options)

        const stringKey = `${this.ns}:${this.dbName}::${this.collectionName}:query${QUERY_DELIMITER}${stringQuery}::${stringFilteredOpts}`
        this._toString = stringKey

        return stringKey
      }

      /* Base key */
      const stringKey = `${this.ns}:${this.dbName}::${this.collectionName}:query${QUERY_DELIMITER}${stringQuery}`
      return stringKey
    } catch (err) {
      throw new FFError(
        'InternalError',
        'key toString has failed.' + err,
        'QueryKey::toString',
        err
      )
    }
  }

  inspect () {
    return this.toString()
  }
}

module.exports = { QueryKey }
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Bucket.html">Bucket</a></li><li><a href="Cache.html">Cache</a></li><li><a href="FerretError.html">FerretError</a></li><li><a href="FireFerret.html">FireFerret</a></li><li><a href="QueryKey.html">QueryKey</a></li></ul><h3>Global</h3><ul><li><a href="global.html#generateOptions">generateOptions</a></li><li><a href="global.html#hashFunction">hashFunction</a></li><li><a href="global.html#makeBucket">makeBucket</a></li><li><a href="global.html#validatePaginationOpts">validatePaginationOpts</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Thu Sep 03 2020 21:35:39 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
